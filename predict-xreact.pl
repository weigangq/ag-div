#!/usr/bin/env perl

use strict;
use warnings;
use Bio::AlignIO;
use Inline::Files;
use Algorithm::Numerical::Sample  qw /sample/;
use Data::Dumper;
use Bio::LocatableSeq;
use Getopt::Std;
use Bio::SeqIO;

my %opts;
getopts('f:', \%opts); # get a single FASTA sequence
die "Required option: -f <FASTA file>\n" unless $opts{f};

my %lk_table;
while(<>) {
    chomp;
    next if /^allle/;
    my ($allele, $pos, $pnear, $pfar, $pmed) = split;
    $lk_table{$allele}{$pos} = { 'pnear' => $pnear, 'pfar' => $pfar, 'pmed' => $pmed};
}
#print Dumper(\%lk_table); exit;

my $aln = Bio::AlignIO->new(-fh=>\*ALN)->next_aln();
my $seq_len = $aln->length();

my $query = Bio::SeqIO->new(-file=>$opts{f})->next_seq();

=b
my @seqs;
foreach ($aln->each_seq){
  my @aa = split //, $_->seq();
  push @seqs, \@aa
}

my $s;
for (my $i=0; $i<$seq_len; $i++){
  my @aa;
  foreach (@seqs){
    my @seq = @{$_};
    push @aa, $seq[$i]
  }
  my @sample = sample(-set=>\@aa);
  $s .= shift @sample
}


my $s = 'MK---LSAIL-TLFLFISCNNSG-D-NASANPADESVKGPNLTEISKKITESNAILLAVKEIETLIASINQLA-KAIGQKIDQD-TLGALQGQNGSLISGAYAIATVVAQN---IDGLKNSGELNEEVEKVKDCSEKFSKKLKSEQTVLGIAN--ATNDNAQRAILKKNNT-KDKGAEELKKLFKALKSLSKVAKEMLAKAVKELTGPIVVES--KP';

my $id = 'query';
my $query = Bio::LocatableSeq->new(-id=>$id, -seq=>$s, -start=>1);
print $s, "\n";
=cut

#my $query = $aln->get_seq_by_id($id);
foreach my $seq ($aln->each_seq) {
    my @bayes_numr = (0, 0, 0);
    my $refId = $seq->id();
    foreach my $pos (sort {$a <=> $b} keys %{$lk_table{$refId}}) {
		  my $prob = $lk_table{$refId}{$pos};
		  my $query_aa = $query->subseq($pos, $pos);
		  my $ref_aa = $seq->subseq($pos, $pos);
		  if ($query_aa eq $ref_aa) {
		    $bayes_numr[0] += log($prob->{'pnear'});
		    $bayes_numr[1] += log($prob->{'pfar'});
		    $bayes_numr[2] += log($prob->{'pmed'});
		  } else {
		    $bayes_numr[0] += log(1-$prob->{'pnear'});
		    $bayes_numr[1] += log(1-$prob->{'pfar'});
		    $bayes_numr[2] += log(1-$prob->{'pmed'});
		  }
    }

    my $prob_near = sprintf "%.6f", exp($bayes_numr[0])/(exp($bayes_numr[0]) + exp($bayes_numr[1]) + exp($bayes_numr[2])); 
    my $prob_far = sprintf "%.6f", exp($bayes_numr[1])/(exp($bayes_numr[0]) + exp($bayes_numr[1]) + exp($bayes_numr[2])); 
    my $prob_mid = sprintf "%.6f", exp($bayes_numr[2])/(exp($bayes_numr[0]) + exp($bayes_numr[1]) + exp($bayes_numr[2])); 

    print join "\t", ($seq->id(), $prob_near, $prob_far, $prob_mid);
    print "\n"
}
exit;

__ALN__
CLUSTAL W (1.81) multiple sequence alignment

G               MKKNTLSAILMTLFLFISCNNSGKDGNASTNSADESVKGPNLAEISKKITESNAVVLAVK
A3              ------------------------------NSADESVKGPNLTEISKKITESNAVVLAVK
E3              ------------------------------NSADESVKGPNLTEISKKITDSNAVVLAVK
E               MKKNTLSAILMTLFLFISCNNSGKDGNASANSADESVKGPNLTEISKKITESNAVVLAVK
N               MKKNTLSAILMTLFLFISCNNSGKDGNASTNSADESVKGPNLTEISKKITESNAVVLAVK
D3              ------------------------------NPADESVKGPNLTEISKKITDSNAIVMAVK
D               MKKNTLSAILMTLFLFISCNNSGKDGNTSANSADESVKGPNLTEISKKITDSNAVLLAVK
F3              ------------------------------NSADESVKGPNLTEISKKITDSNAVVLAVK
C3              ------------------------------NSADESVKGPNLAEISKKITESNAVVLAVK
H3              ------------------------------NSADESVKGPNLTEISKKITNSNAVVLAVK
M               MKKNTLSAILMTLFLFISCNNSGKDGNTSANSADESVKGPNLTEISKKITESNAVVLAVK
K               MKKNTLSAILMTLFLFISCNNSGKDGNTSANSADESVKGPNLTEISKKITESNAVVLAVK
U               MKKNTLSAILMTLFLFISCNNSGKDGNASANSADESVKGPNLAEISKKITESNAVVLAVK
A               MKKNTLSAILMTLFLFISCNNSGKDGNTSANSADESVKGPNLTEISKKITDSNAVLLAVK
B               MKKNTLSAILMTLFLFISCNNSGKDGNTSANSADESVKGPNLTEISKKITDSNAVLLAVK
I               MKKNTLSAILMTLFLFISCNNSGKDGNTSANSADESVKGPNLTEISKKITESNAVVLAVK
C               MKKNTLSAILMTLFLFISCNNSGKDGNASANSADESVKGPNLTEISKKITESNAVVLAVK
T               MKKNTLSAILMTLFLFISCNNSGKDGNASVNSADESVKGPNLTEISKKITESNAVVLAVK
F               MKKNTLSAILMTLFLFISCNNSGKDGNTSANSADESVKGPNLTEISKKITESNAVVLAVK
I3              ------------------------------NSADESVKGPNLTEISKKITESNAVVLAVK
L               MKKNTLSAILMTLFLFISCNNSGKDGNASVNSADESVKGPNLVEISKKITDSNAVVIAVK
H               MKKNTLSAILMTLFLFISCNNSGKDGNASANSADESVKGPNLTEISKKITESNAVVLAVK
J               MKKNTLSAILMTLFLFISCNNSGKDGNTSANSADESVKGPNLTEISKKITESNAVVLAVK
                                              *.**********.*******:***:::***

G               EVAALLSSIDELA-KAIGKKIEQN-GLGADANHNTSLLAGAHEISTLIKQK---LDGLKN
A3              EVETLLASIDELA-KAIGQKIGAN-GLTAQAAQNGSLLAGAYAISSLITEK---LNKFKD
E3              EIETLLSSIDELATKAIGKKIQQNSGLGVEANRNESLLAGACVISTLITEK---LSKLSG
E               EVETLLASIDELATKAIGKKIGNN-GLEANQSKNTSLLSGAYAISDLIAEK---LNVLKN
N               EVAALLSSIDELA-KAIGKKINNN-GLDDVQNFNASLLAGAHTISKLVTEK---LSKLKN
D3              EVETLLTSIDELA-KAIGKKINNN-GLDALQNFNASLLGGAHTISKLITEK---LSKLNG
D               EVEVLLSSIDELAKKAIGKKIDQNNALGTLDNHNGSLLAGAYAISALITEK---LSSIKD
F3              EVETLLASIDEIAAKAIGKKIDQNNALGTLDNHNGSLLAGAYAISALITKK---LSSIKD
C3              EVETLISSIDEIAAKAIGKKIKNDGSLDNDANHNGSLLAGAYAISTLITQK---LGGLKN
H3              EVETLLASIDELANKAIGKQITAN-GLNAQAGQNGTLLAGAYAISVLIAEK---LNILKN
M               EVETLLASIDEVAKKAIGNLIAQN-GLNAGANQNGSLLAGAYVISTLIAEK---LDGLKN
K               EIETLLASIDELATKAIGKKIQQNGGLAVEAGHNGTLLAGAYTISKLITQK---LDGLKN
U               EVEALLASIDEIGSKAIGKRIQAN-GLQDLQGQNGSLLAGAYAISNLITQKINVLNGLKN
A               EVEALLSSIDEIAAKAIGKKIHQNNGLDTENNHNGSLLAGAYAISTLIKQK---LDGLKN
B               EVEALLSSIDELA-KAIGKKIKNDGSLDNEANRNESLLAGAYTISTLITQK---LSKLNG
I               EVETLLTSIDELA-KAIGKKIKNDVSLDNEADHNGSLISGAYLISTLITKK---ISAIKD
C               EVETLLASIDELA-KAIGKKIKNDVSLDNEADNNGSLIAGAYTISTLITQK---LSKLNG
T               EVETLLASIDELANKAIGQKIDQNNGLSVDAGHNGPLLAGAYAISALITEK---LNGLTI
F               EIETLLSSIDELATKAIGQKIDAN-GLGVQANQNGSLLAGAYAISTLITQK---LSAL-N
I3              EIETLLSSIDELATKAIGQKIDAN-GLGVQADQNGSLLAGAYAISTLITQK---LSAL-N
L               EVETLLVSIDELA-KAIGKKIEAGGTLGSDGAHNGSLLAGAYKIATEITAN---LSKLKA
H               EVETLLASINQLA-KAIGKKIDQNGTLGDDGGQNGSLLAGAYAISTVIIEK---LSTLKN
J               EIETLLASIDELATKAIGKKIDNNAGLGAEVGQNGSLLAGAYAISTVIIEK---LSTLKN
                *: .*: **:::. ****: *  .  *      * .*:.**  *:  :  :   :. :  

G               -EGLNKEIEAAKKCSAAFTKKLADSNADLGVAAGNATDDNAKRAILKTHGH-EDKGGKEL
A3              LEGLKEKINDAKKCSEAFTNKLKGEQATLGQQN--ASDDDAKKAILKTHGT-PDKGAKEL
E3              SEGLKEKIEAAKNCSEQFTKKLKDSHGELGVQN--VTDDNAKKAILKTNND-KTKGADEL
E               -EELKEKIDTAKQCSTEFTNKLKSEHAVLGLDN--LTDDNAQRAILKKHAN-KDKGAAEL
N               SEGLKEKIEDAKKCSDDFTKKLQSSHAQLGVAGGATTDEEAKKAILRTNAI-KDKGADEL
D3              SEGLKEKIEDAKKCSDDFTKKLQSSHAVLGVAGGATTDEEAKKAILRTNSV-KDKGAEEL
D               SGELKAEIEKAKKCSESFTKKLSDNQAELGIEN--ATDDNAKKAILKTHNA-KDKGAEEL
F3              SGELKAEIEKAKKCSEAFTAKLKGEHTDLGKED--VTNAHAQEAILKTNGA-NDKGAKEL
C3              SEELKEKIEEAKKCNKAFTEKLKSSHAELGKQD--AQDDDAKKAILRTHNT-KDKGAEEL
H3              -DELKEKIEDAKKCTKAFTDKLKSSHGNLGQA---ADDDNAKKAILKTNQAGKDKGAEEL
M               SEELKEKIEDAKKCNKAFTDKLKSSHAELGIANGAATDANAKAAILKTNGT-KDKGAQEL
K               SEKLKEKIENAKKCSEDFTKKLEGEHAQLGIEN--VTDENAKKAILITDAA-KDKGAAEL
U               SEELKEKINEAKGCSEKFTKKLSESHADIGIQA--ATDANAKDAILKTNPT-KTKGAEEL
A               -EGLKEKIDAAKKCSETFTNKLKEKHTDLGKEG--VTDADAKEAILKTNGT-KTKGAEEL
B               SEGLKEKIAAAKKCSEEFSTKLKDNHAQLGIQG--VTDENAKKAILKANAAGKDKGVEEL
I               SGELKAEIEKAKKCSEEFTAKLKGEHTDLGKEG--VTDDNAKKAILKTNND-KTKGADEL
C               SEGLKEKIAEAKKCSEEFTKKLKEKHTDLGKKD--ATDVHAKEAILKTNGT-KDKGAAEL
T               SEELKEKIEKAKKCSTGFTNKLKSGHAELGPVGGNATDENAKQAILKTHGN-VTKGAKEL
F               SEDLKEKVAKVKKCSEDFTNKLKNGNAQLGLAA--ATDDNAKAAILKTNGT-NDKGAKEL
I3              SENLKEKVAKVKKCSEDFTNKLKNGNAQLGLAA--ATDADAKEAILKTNGT-KTKGAEEL
L               SEDLKEKITKAKECSEKFTDKLKSENVALGKQD--ASDDDAKKAILKTHND-ITKGAKEL
H               VEELKEKITKAKDCSEKFAGKLKNEHASLGKKD--ATDDDAKKAILKTHGN-TDKGAKEL
J               VEELKEKITKAKDCSEKFTKKLKDSHAELGKKD--ASDDDAKKAILKTNQA-NDKGAKEL
                   *: ::  .* *.  *: **   :  :*       :  *: ***        **  **

G               KELSEAVKSLLKAAQAALANSVQELTSPVVAETPKKP
A3              KDLSESVAGLLKVAKEMLANSVKELTSPVVAET----
E3              EKLFKAVEVLSKAAKEMLTNAVKELTSPVVAET----
E               EKLFKAVENLSKAAQDTLKNAVKELTSPIVAESPKKP
N               EKLFKSVESLAKAAQDALANSVNELTGPVVAETPKKP
D3              GKLFESVESLSKAAKDKLNNSVKELTSPVVAET----
D               VKLSESVAGLLKAAQAILANSVKELTSPVVAESPKKP
F3              KDLSDSVESLVKAAKEMLTNSVKELTSPVVAES----
C3              DKLFKAVENLSKAAKEMLSNSVKELTSPVVAET----
H3              EKLFESVRALSKAAQDALTNAVKELTSPVVAES----
M               EKLFESVKNLSKAAQETLNNSVKELTSPVVAENPKKP
K               EKLFKAVENLAKAAKEMLANSVKELTSPIVAESPKNP
U               DKLFKAVENLSKAAKEMLANSVKELTSPVVAESPKKP
A               GKLFESVEVLSKAAKEMLANSVKELTSPVVAESPKKP
B               EKLSGSLESLSKAAKEMLANSVKELTSPVVVESPKKP
I               EKLFESVKNLSKAAKEMLTNSVKELTSPVVAESPKKP
C               EKLFESVENLAKAAKEMLSNSVKELTSPVVAESPKNP
T               KDLSESVEALAKAAQAMLTNSVKELTSPVVAETPKKP
F               KDLSDSVESLVKAAQVMLTNSVKELTSPVVAESPKKP
I3              GKLFESVEVLSKAAKEMLANSVKELTSPVVAES----
L               KELSESVETLLKAAKEMLANSVKELTSPVVAESPKKP
H               KDLSDSVESLVKAAKEMLTNSVKELTSPVVAESPKKP
J               KELFEAVESLSKAAKEMLNKSVKELTSPIVAESPKNP
                 .*  ::  * *.*:  * ::*:***.*:*.*.    


